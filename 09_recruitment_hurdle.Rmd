---
title: "recruitment"
author: "Anne"
date: "27/11/2020"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




########################################################################
## Generell test for zero inflation for recruitment response variable ##
#######################################################################
```{r}
load("processdata/recruits.rda")

library(ggplot2)
library(ggpubr)

ggplot(recruits, aes(recruitment)) +
  geom_histogram(fill = "#0073C2FF") +
  theme_pubclean()

str(recruits$recruitment)
summary(recruits$recruitment)



#### Test for zero-inflation

# Use glmmTMB package to run glm
library("glmmTMB")
m_test_zi <- glm(recruitment ~ disthus + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac, family = poisson, data = recruits)

library("performance")
check_zeroinflation(m_test_zi)

# # Check for zero-inflation
# 
#    Observed zeros: 13066
#   Predicted zeros: 4
#             Ratio: 0.00
# 
# Model is underfitting zeros (probable zero-inflation).



```




###################################################################################
##     HOUSE                HOUSE                 HOUSE                       #####
###################################################################################

##       House binary - First part of hurdle model to account for zero inflation  ##


## Bin house threshold distance to house

#### Load data house models
```{r}
load("processdata/recruits.rda")
names(recruits)

recruits_house <- recruits

# load("processdata/recruits_house.rda")

names(recruits_house)
```


#### Scale variables if necessary
```{r}

recruits_house$disthus <- scale(recruits_house$disthus)

recruits_house$distvei2 <- scale(recruits_house$distvei2)

recruits_house$beitetrykk9 <- scale(recruits_house$beitetrykk9)
recruits_house$helling <- scale(recruits_house$helling)
recruits_house$HOH <- scale(recruits_house$HOH)
recruits_house$moose_density <- scale(recruits_house$moose_density)

recruits_house$disthus_600 <- scale(recruits_house$disthus_600)

recruits_house$disthus_500 <- scale(recruits_house$disthus_500)

recruits_house$disthus_400 <- scale(recruits_house$disthus_400)
recruits_house$disthus_350 <- scale(recruits_house$disthus_350)
recruits_house$disthus_300 <- scale(recruits_house$disthus_300)
recruits_house$disthus_200 <- scale(recruits_house$disthus_200)
recruits_house$disthus_150 <- scale(recruits_house$disthus_150)

summary(recruits_house$disthus)
```


#### Checking for the cut for disthus
```{r}
library(lme4)

# fitting glmm with glmmTMB
# glmmTMB(count~spp + (1|site), Salamanders, family=poisson)


bin_cuthouse1 <- glmer(factor(recruitment > 0) ~ disthus + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

bin_cuthouse2 <- glmer(factor(recruitment > 0) ~ disthus_600 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

bin_cuthouse3 <- glmer(factor(recruitment > 0) ~ disthus_500 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house) # BEST

bin_cuthouse4 <- glmer(factor(recruitment > 0) ~ disthus_400 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

bin_cuthouse5 <- glmer(factor(recruitment > 0) ~ disthus_350 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

bin_cuthouse6 <- glmer(factor(recruitment > 0) ~ disthus_300 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

bin_cuthouse7 <- glmer(factor(recruitment > 0) ~ disthus_200 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

bin_cuthouse8 <- glmer(factor(recruitment > 0) ~ disthus_150 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

```

#### AIC selection threshold house
```{r}
library(AICcmodavg)

candmods_bin_cuthouse <- list(bin_cuthouse1, bin_cuthouse2, bin_cuthouse3, bin_cuthouse4, bin_cuthouse5, bin_cuthouse6, bin_cuthouse7, bin_cuthouse8)
aictab(candmods_bin_cuthouse, modnames = NULL,
                       second.ord = TRUE, nobs = NULL, sort = TRUE)

# Model selection based on AICc:
# 
#       K     AICc Delta_AICc AICcWt Cum.Wt        LL
# Mod3 19 22793.10       0.00   0.47   0.47 -11377.53
# Mod2 19 22793.16       0.06   0.46   0.93 -11377.56
# Mod4 19 22797.02       3.92   0.07   1.00 -11379.49
# Mod5 19 22803.39      10.29   0.00   1.00 -11382.67
# Mod6 19 22811.30      18.20   0.00   1.00 -11386.63
# Mod7 19 22825.88      32.78   0.00   1.00 -11393.92
# Mod8 19 22840.43      47.33   0.00   1.00 -11401.20
# Mod1 19 22866.55      73.45   0.00   1.00 -11414.26

```

#### Save recruits_house dataset
```{r}
str(recruits)
names(recruits)
recruits_house <- recruits[, -c(4,19:23)]
names(recruits_house)
save(recruits_house, file = "recruits_house.rda")

```




## Bin house models

#### Load data
```{r}
load("processdata/recruits_house.rda")
str(recruits_house)
recruits_house$recruitment_bin <- ifelse(recruits_house$recruitment == 0, 0, 1)

```

#### Scale variables if necessary
```{r}

# recruits_house$disthus <- scale(recruits_house$disthus)

# recruits_house$distvei2 <- scale(recruits_house$distvei2)

recruits_house$beitetrykk9 <- scale(recruits_house$beitetrykk9)
recruits_house$helling <- scale(recruits_house$helling)
recruits_house$HOH <- scale(recruits_house$HOH)
recruits_house$moose_density <- scale(recruits_house$moose_density)

# recruits_house$disthus_600 <- scale(recruits_house$disthus_600)

recruits_house$disthus_500 <- scale(recruits_house$disthus_500)

summary(recruits_house$beitetrykk9)
```



```{r}
library(lme4)
rec_h_bin1 <- glmer(recruitment_bin ~ disthus_500 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)
summary(rec_h_bin1)

rec_h_bin2 <- glmer(recruitment_bin ~ disthus_500 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

rec_h_bin3 <- glmer(recruitment_bin ~ skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

rec_h_bin4 <- glmer(recruitment_bin ~ log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

rec_h_bin5 <- glmer(recruitment_bin ~ log(disthus_500+1) + log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house) 

rec_h_bin6 <- glmer(recruitment_bin ~ log(disthus_500+1) + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)

rec_h_bin7 <- glmer(recruitment_bin ~ disthus_500 + log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house)  # BEST

rec_h_bin7_600 <- glmer(recruitment_bin ~ disthus_600 + log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_house) # Same as rec_h_bin7, only run with disthus_600, so that both recruits house models have the same disthus variables - easier in the function
summary(rec_h_bin7_600)

save(rec_h_bin7_600, file = "output/recruitment_07_12_2020/rec_h_bin7_600.rda")
```

#### AIC selection bin models
```{r}
library(AICcmodavg)

candmods_rec_house_bin <- list(rec_h_bin1, rec_h_bin2, rec_h_bin3, rec_h_bin4, rec_h_bin7)
aictab(candmods_rec_house_bin, modnames = NULL,
                       second.ord = TRUE, nobs = NULL, sort = TRUE)

# Model selection based on AICc:
# 
#       K     AICc Delta_AICc AICcWt Cum.Wt        LL
# Mod5 19 22754.24       0.00      1      1 -11358.10
# Mod1 19 22793.10      38.86      0      1 -11377.53
# Mod4 18 22796.88      42.64      0      1 -11380.42
# Mod2 18 22802.45      48.21      0      1 -11383.21
# Mod3 17 22922.22     167.98      0      1 -11444.09
```

#### Summary bin house
```{r}
summary(rec_h_bin7)
# vcov(rec_h_bin5)
```



#### Plots bin house
```{r}
# library(effects)
# 
# plot(allEffects(rec_h_bin)5)
# plot(effect("skogkategori", rec_h_bin5))

## TRY also performance::check_model for model assumptions and model performance summaries with performance::model_performance; to test performance between models use compare_performance (can be for glm, lm, lmerMod at the same time)
library(sjPlot)
plot_model(rec_h_bin7, type = "diag")
plot_model(rec_h_bin7, type = "eff")
plot_model(rec_h_bin7, type = "est")

library(performance)
# check_model(rec_h_bin7)
model_performance(rec_h_bin7)

 
# tab_model(rec_h_bin5, transform = NULL, 
#           show.intercept = TRUE, show.est = TRUE, show.ci = 0.95, show.se = TRUE, show.std = NULL, show.p = TRUE, show.stat = FALSE, show.df = FALSE, show.zeroinf = FALSE, show.r2 = TRUE, show.icc = TRUE, show.adj.icc = FALSE, show.re.var = TRUE, show.aic = TRUE, show.dev = FALSE, show.obs = TRUE, p.threshold = c(0.05, 0.01, 0.001))

ggstatsplot::ggcoefstats(
  x = rec_h_bin7,
  title = "generalized linear mixed-effects model"
)

```

#### Save bin house
```{r}
save(rec_h_bin7, file = "rec_h_bin7.rda")

```




##       House beta - Second part of the hurdle, Poisson  ##


## Load data house models
```{r}

## !! Use recruits_house - all variables needed are in there !! ##


load("processdata/recruits_house.rda")
str(recruits_house)
names(recruits_house)

```



#### Prepare data set for second part of the hurdle
```{r}
recruits_house <- recruits_house[recruits_house$recruitment > 0, ]
str(recruits_house)
summary(recruits_house$recruitment)

is.integer(recruits_house$recruitment)
recruits_house$recruitment <- as.integer(recruits_house$recruitment)
is.integer(recruits_house$recruitment)
```


#### Scale variables if necessary
```{r}
recruits_house$disthus <- scale(recruits_house$disthus)
recruits_house$distvei2 <- scale(recruits_house$distvei2)

recruits_house$beitetrykk9 <- scale(recruits_house$beitetrykk9)
recruits_house$helling <- scale(recruits_house$helling)
recruits_house$HOH <- scale(recruits_house$HOH)
recruits_house$moose_density <- scale(recruits_house$moose_density)

recruits_house$disthus_600 <- scale(recruits_house$disthus_600)

recruits_house$disthus_500 <- scale(recruits_house$disthus_500)

recruits_house$disthus_400 <- scale(recruits_house$disthus_400)
recruits_house$disthus_350 <- scale(recruits_house$disthus_350)
recruits_house$disthus_300 <- scale(recruits_house$disthus_300)
recruits_house$disthus_200 <- scale(recruits_house$disthus_200)
recruits_house$disthus_150 <- scale(recruits_house$disthus_150)

summary(recruits_house$disthus_600)
```

#### Checking for the cut for disthus
```{r}
library(lme4)


beta_cuthouse1 <- glmer(recruitment ~ disthus + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

beta_cuthouse2 <- glmer(recruitment ~ disthus_600 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house) # BEST

beta_cuthouse3 <- glmer(recruitment ~ disthus_500 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house) 

beta_cuthouse4 <- glmer(recruitment ~ disthus_400 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

beta_cuthouse5 <- glmer(recruitment ~ disthus_350 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

beta_cuthouse6 <- glmer(recruitment ~ disthus_300 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

beta_cuthouse7 <- glmer(recruitment ~ disthus_200 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

beta_cuthouse8 <- glmer(recruitment ~ disthus_150 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

```

#### AIC selection threshold house
```{r}
library(AICcmodavg)

candmods_beta_cuthouse <- list(beta_cuthouse1, beta_cuthouse2, beta_cuthouse3, beta_cuthouse4, beta_cuthouse5, beta_cuthouse6, beta_cuthouse7, beta_cuthouse8)
candmods_beta_cuthouse <- list(beta_cuthouse1, beta_cuthouse2, beta_cuthouse3)
aictab(candmods_beta_cuthouse, modnames = NULL,
                       second.ord = TRUE, nobs = NULL, sort = TRUE)

# Model selection based on AICc:
# 
#       K    AICc Delta_AICc AICcWt Cum.Wt        LL
# Mod3 19 1169628       0.00      1      1 -584795.1
# Mod2 19 1169652      24.02      0      1 -584807.1
# Mod4 19 1170944    1315.69      0      1 -585452.9
# Mod5 19 1171870    2241.21      0      1 -585915.7
# Mod6 19 1172960    3331.47      0      1 -586460.8
# Mod7 19 1174929    5300.67      0      1 -587445.4
# Mod8 19 1175241    5612.60      0      1 -587601.4
# Mod1 19 1177803    8174.82      0      1 -588882.5

```


#### Save recruits_house_beta dataset
```{r}
## !! Use recruits_house - all variables needed are in there !! ##



```


## Beta house models

#### Load models
```{r}
load("processdata/recruits_house.rda")
str(recruits_house)
names(recruits_house)
```


#### Prepare data set for second part of the hurdle
```{r}
recruits_house <- recruits_house[recruits_house$recruitment > 0, ]
str(recruits_house)
summary(recruits_house$recruitment)

is.integer(recruits_house$recruitment)
recruits_house$recruitment <- as.integer(recruits_house$recruitment)
is.integer(recruits_house$recruitment)
```


#### Scale variables if necessary
```{r}
# recruits_house$disthus <- scale(recruits_house$disthus)

# recruits_house$distvei2 <- scale(recruits_house$distvei2)

recruits_house$beitetrykk9 <- scale(recruits_house$beitetrykk9)
recruits_house$helling <- scale(recruits_house$helling)
recruits_house$HOH <- scale(recruits_house$HOH)
recruits_house$moose_density <- scale(recruits_house$moose_density)

recruits_house$disthus_600 <- scale(recruits_house$disthus_600)

# recruits_house$disthus_500 <- scale(recruits_house$disthus_500)

summary(recruits_house$disthus_600)
```


#### Beta house models
```{r}
library(lme4)
rec_h_beta1 <- glmer(recruitment ~ disthus_600 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)
summary(rec_h_beta1)

rec_h_beta2 <- glmer(recruitment ~ disthus_600 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

rec_h_beta3 <- glmer(recruitment ~ distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

rec_h_beta4 <- glmer(recruitment ~ disthus_600 + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

rec_h_beta5 <- glmer(recruitment ~ log(disthus_600+1) + log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house) 

rec_h_beta6 <- glmer(recruitment ~ log(disthus_600+1) + distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house)

rec_h_beta7 <- glmer(recruitment ~ disthus_600 + log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_house) # BEST

summary(rec_h_beta7)


library(glmmTMB)
rec_h_beta7_TMB <- glmmTMB(recruitment ~ disthus_600 + log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
                           family = poisson,
                           data = recruits_house) # Same as rec_h_beta7, just run with glmmTMB
summary(rec_h_beta7_TMB)
save(rec_h_beta7_TMB, file = "rec_h_beta7_TMB.rda")
```


#### AIC selection beta models
```{r}
library(AICcmodavg)

candmods_rec_house_beta <- list(rec_h_beta1, rec_h_beta2, rec_h_beta3, rec_h_beta4, rec_h_beta7)
# candmods_rec_house_beta <- list(rec_h_beta4, rec_h_beta7)
aictab(candmods_rec_house_beta, modnames = NULL,
                       second.ord = TRUE, nobs = NULL, sort = TRUE)

# Model selection based on AICc:
# 
#       K    AICc Delta_AICc AICcWt Cum.Wt        LL
# Mod5 18 1143746       0.00      1      1 -571855.0
# Mod4 18 1145904    2157.79      0      1 -572933.9
# Mod1 19 1145905    2159.37      0      1 -572933.7
# Mod2 18 1147541    3794.63      0      1 -573752.3
# Mod3 18 1154173   10426.57      0      1 -577068.3

```


#### Summary beta house
```{r}
summary(rec_h_beta7)
# vcov(rec_h_bin5)
```



#### Plots beta house
```{r}
# library(effects)
# plot(allEffects(rec_h_beta7))
# plot(effect("skogkategori", rec_h_beta7))

library(sjPlot)
plot_model(rec_h_beta7, type = "diag")
plot_model(rec_h_beta7, type = "eff")
plot_model(rec_h_beta7, type = "est")

library(performance)
check_model(rec_h_bin7)
model_performance(rec_h_bin7)

# tab_model(rec_h_beta7, transform = NULL,
#           show.intercept = TRUE, show.est = TRUE, show.ci = 0.95, show.se = TRUE, show.std = NULL, show.p = TRUE, show.stat = FALSE, show.df = FALSE, show.zeroinf = FALSE, show.r2 = TRUE, show.icc = TRUE, show.adj.icc = FALSE, show.re.var = TRUE, show.aic = TRUE, show.dev = FALSE, show.obs = TRUE, p.threshold = c(0.05, 0.01, 0.001)) 
# Is it not working because of the scaled variables?





ggstatsplot::ggcoefstats(
  x = rec_h_beta7,
  title = "generalized linear mixed-effects model"
) # Not sure what exactly this shows.

```


#### Save house beta model
```{r}
save(rec_h_beta7, file = "rec_h_beta7.rda")
```








###################################################################################
##     ROADS                ROADS                 ROADS                       #####
###################################################################################

##       Roads Bin - First part of a hurdle model to account for zero inflation  ##


## Bin roads

#### Load data roads models
```{r}
load("processdata/recruits_roads.rda")

recruits_roads$recruitment_bin <- ifelse(recruits_roads$recruitment == 0, 0, 1)
str(recruits_roads)
names(recruits_roads)

```



#### Scale variables if necessary
```{r}
# recruits_roads$distvei2 <- scale(recruits_roads$distvei2)

recruits_roads$beitetrykk9 <- scale(recruits_roads$beitetrykk9)
recruits_roads$helling <- scale(recruits_roads$helling)
recruits_roads$HOH <- scale(recruits_roads$HOH)
recruits_roads$moose_density <- scale(recruits_roads$moose_density)

summary(recruits_roads$beitetrykk9)
```



## Bin roads models
```{r}
library(lme4)
rec_r_bin1 <- glmer(recruitment_bin ~ distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_roads)
summary(rec_r_bin1) 

rec_r_bin2 <- glmer(recruitment_bin ~ skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_roads) 


rec_r_bin3  <- glmer(recruitment_bin ~ log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = binomial(),
data = recruits_roads) # BEST



```

#### AIC selection bin models
```{r}
library(AICcmodavg)

candmods_rec_roads_bin <- list(rec_r_bin1, rec_r_bin2, rec_r_bin3)
aictab(candmods_rec_roads_bin, modnames = NULL,
                       second.ord = TRUE, nobs = NULL, sort = TRUE)

# Model selection based on AICc:
# 
#       K     AICc Delta_AICc AICcWt Cum.Wt       LL
# Mod3 18 13840.01       0.00      1      1 -6901.98
# Mod1 18 13854.89      14.88      0      1 -6909.42
# Mod2 17 13856.76      16.75      0      1 -6911.36

```

#### Summary bin roads
```{r}
summary(rec_r_bin3)
# vcov(rec_h_bin5)
```



#### Plots bin roads
```{r}
# library(effects)
# 
# plot(allEffects(rec_r_bin7))
# plot(effect("skogkategori", rec_r_bin7))

library(performance)
# check_model(rec_r_bin3)
model_performance(rec_r_bin3)

library(sjPlot)
plot_model(rec_r_bin3, type = "diag")
plot_model(rec_r_bin3, type = "eff")
plot_model(rec_r_bin3, type = "est")

# tab_model(rec_r_bin7, transform = NULL,
#           show.intercept = TRUE, show.est = TRUE, show.ci = 0.95, show.se = TRUE, show.std = NULL, show.p = TRUE, show.stat = FALSE, show.df = FALSE, show.zeroinf = FALSE, show.r2 = TRUE, show.icc = TRUE, show.adj.icc = FALSE, show.re.var = TRUE, show.aic = TRUE, show.dev = FALSE, show.obs = TRUE, p.threshold = c(0.05, 0.01, 0.001))

ggstatsplot::ggcoefstats(
  x = rec_r_bin3,
  title = "generalized linear mixed-effects model"
)

```

#### Save bin roads
```{r}
save(rec_r_bin3, file = "rec_r_bin3.rda")

```




##       Roads beta - Second part of the hurdle, Poisson  ##


## Load data road models
```{r}
load("processdata/recruits_roads.rda")

names(recruits_roads)
```


#### Prepare data set for second part of the hurdle
```{r}
recruits_roads <- recruits_roads[recruits_roads$recruitment > 0, ]
str(recruits_roads)
summary(recruits_roads$recruitment)

is.integer(recruits_roads$recruitment)
recruits_roads$recruitment <- as.integer(recruits_roads$recruitment)
is.integer(recruits_roads$recruitment)

```


#### Scale variables if necessary
```{r}

# recruits_roads$distvei2 <- scale(recruits_roads$distvei2)

recruits_roads$beitetrykk9 <- scale(recruits_roads$beitetrykk9)
recruits_roads$helling <- scale(recruits_roads$helling)
recruits_roads$HOH <- scale(recruits_roads$HOH)
recruits_roads$moose_density <- scale(recruits_roads$moose_density)


```


## Beta roads models
```{r}
library(lme4)
rec_r_beta1 <- glmer(recruitment ~ distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) + moose_density +  ac + (1|KOMNR),
family = poisson(),
data = recruits_roads)
summary(rec_r_beta1)

rec_r_beta2 <- glmer(recruitment ~ distvei2 + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_roads)

rec_r_beta3 <- glmer(recruitment ~ skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_roads)

rec_r_beta4 <- glmer(recruitment ~ log(distvei2+1) + skogkategori + treartgruppe9 + beitetrykk9 + kant + helling + HOH + I(HOH^2) +  ac + (1|KOMNR),
family = poisson(),
data = recruits_roads)




```


#### AIC selection beta models
```{r}
library(AICcmodavg)

candmods_rec_roads_beta <- list(rec_r_beta1, rec_r_beta2, rec_r_beta3, rec_r_beta4)
aictab(candmods_rec_roads_beta, modnames = NULL,
                       second.ord = TRUE, nobs = NULL, sort = TRUE)

# Model selection based on AICc:
# 
#       K     AICc Delta_AICc AICcWt Cum.Wt        LL
# Mod4 17 483630.2       0.00      1      1 -241798.0
# Mod1 18 484607.9     977.76      0      1 -242285.9
# Mod2 17 484608.2     978.08      0      1 -242287.0
# Mod3 16 485370.0    1739.88      0      1 -242669.0
```


#### Summary beta roads
```{r}
summary(rec_r_beta4)
# vcov(rec_h_bin5)
```



#### Plots beta roads
```{r}
# library(effects)
# 
# plot(allEffects(rec_r_beta4))
# plot(effect("skogkategori", rec_r_beta4))

library(performance)
check_model(rec_r_beta4)
model_performance(rec_r_beta4)

library(sjPlot)
plot_model(rec_r_beta4, type = "diag")
plot_model(rec_r_beta4, type = "eff") 
plot_model(rec_r_beta4, type = "est")

# tab_model(rec_h_beta4, transform = NULL,
#           show.intercept = TRUE, show.est = TRUE, show.ci = 0.95, show.se = TRUE, show.std = NULL, show.p = TRUE, show.stat = FALSE, show.df = FALSE, show.zeroinf = FALSE, show.r2 = TRUE, show.icc = TRUE, show.adj.icc = FALSE, show.re.var = TRUE, show.aic = TRUE, show.dev = FALSE, show.obs = TRUE, p.threshold = c(0.05, 0.01, 0.001))

ggstatsplot::ggcoefstats(
  x = rec_r_beta4,
  title = "generalized linear mixed-effects model"
)

```


#### Save roads beta model
```{r}
save(rec_r_beta4, file = "rec_r_beta4.rda")
```




## Figures bin
```{r}
library(sjPlot)
library(ggplot2)

## House
load("processdata/recruits_house.rda")
str(recruits_house) # Check if variables are scales - if not scale
load("output/recruitment_07_12_2020/rec_h_bin7.rda")
recruits_house$recruitment_bin <- ifelse(recruits_house$recruitment == 0, 0, 1)
summary(rec_h_bin7)

# scale
recruits_house$beitetrykk9 <- scale(recruits_house$beitetrykk9)
recruits_house$helling <- scale(recruits_house$helling)
recruits_house$HOH <- scale(recruits_house$HOH)
recruits_house$moose_density <- scale(recruits_house$moose_density)


p_rec_bin1_house <- plot_model(rec_h_bin7, type = c("eff"), transform = NULL, terms = c("disthus_500"))
p_rec_bin1_house <- p_rec_bin1_house + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Distance to houses\n") +
  ylab("Recruitment\n")



## Roads
load("processdata/recruits_roads.rda")
str(recruits_roads) # Check if variables are scales - if not scale
load("output/recruitment_07_12_2020/rec_r_bin3.rda")
recruits_roads$recruitment_bin <- ifelse(recruits_roads$recruitment == 0, 0, 1)
summary(rec_r_bin3)

# scale
recruits_roads$beitetrykk9 <- scale(recruits_roads$beitetrykk9)
recruits_roads$helling <- scale(recruits_roads$helling)
recruits_roads$HOH <- scale(recruits_roads$HOH)
recruits_roads$moose_density <- scale(recruits_roads$moose_density)



p_rec_bin1 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("distvei2  [0:500]"))
p_rec_bin1 <- p_rec_bin1 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Distance to road\n") +
  ylab("Recruitment\n")


p_rec_bin2 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("skogkategori"))
p_rec_bin2 <- p_rec_bin2 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 12, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30"),
    axis.text.x = element_text(angle = 30)) +
  xlab("Forest category\n") +
  ylab("Recruitment\n") 


p_rec_bin3 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("treartgruppe9"))
p_rec_bin3 <- p_rec_bin3 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Tree species group\n") +
  ylab("Recruitment\n") 


p_rec_bin4 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("kant"))
p_rec_bin4 <- p_rec_bin4 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 12, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30"),
    axis.text.x = element_text(angle = 30)) +
  xlab("Edge\n") +
  ylab("Recruitment\n")


p_rec_bin5 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("helling [all]"))
p_rec_bin5 <- p_rec_bin5 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Slope\n") +
  ylab("Recruitment\n")


p_rec_bin6 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("HOH [all]"))
p_rec_bin6 <- p_rec_bin6 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Altitude\n") +
  ylab("Recruitment\n")


p_rec_bin7 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("moose_density [all]"))
p_rec_bin7 <- p_rec_bin7 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Moose density\n") +
  ylab("Recruitment\n")


p_rec_bin8 <- plot_model(rec_r_bin3, type = c("eff"), transform = NULL, terms = c("beitetrykk9 [all]"))
p_rec_bin8 <- p_rec_bin8 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Browsing pressure\n") +
  ylab("Recruitment\n")




library(gridExtra)
grid.arrange(p_rec_bin1_house, p_rec_bin1, p_rec_bin2, p_rec_bin3,
          nrow = 2, ncol = 2)

grid.arrange(p_rec_bin8, p_rec_bin4, p_rec_bin5, p_rec_bin6, p_rec_bin7,
          nrow = 3, ncol = 2)

# type = "pred" = Predicted values (marginal effects) for specific model terms. See ggpredict for details.
# type = "eff" = Similar to type = "pred", however, discrete predictors are held constant at their proportions (not reference level). See ggeffect for details. ggeffect() computes marginal effects by internally calling Effect. Effect constructs an "eff" object for a term (usually a high-order term), absorbing the lower-order terms marginal to the term in question, and averaging over other terms in the model.

```



## Figures beta
```{r}
library(sjPlot)
library(ggplot2)

## House
load("processdata/recruits_house.rda")
str(recruits_house)
load("output/recruitment_07_12_2020/rec_h_beta7.rda")
recruits_house$recruitment_bin <- ifelse(recruits_house$recruitment == 0, 0, 1)
summary(rec_h_beta7)

# scale
recruits_house$beitetrykk9 <- scale(recruits_house$beitetrykk9)
recruits_house$helling <- scale(recruits_house$helling)
recruits_house$HOH <- scale(recruits_house$HOH)
recruits_house$moose_density <- scale(recruits_house$moose_density)


p_rec_beta1_house <- plot_model(rec_h_beta7, type = c("eff"), transform = NULL, terms = c("disthus_600"))
p_rec_beta1_house <- p_rec_beta1_house + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Distance to houses\n") +
  ylab("Recruitment\n")



# p_rec_test <- plot_model(rec_h_beta7_TMB, type = c("eff"), transform = NULL, terms = c("disthus_600"))
# p_rec_test <- p_rec_test + theme_light() +
#   theme(plot.title = element_blank(),
#     axis.text = element_text(family = "sans", size = 20, color = "grey30"),
#         axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
#   xlab("Distance to houses\n") +
#   ylab("Recruitment\n")


## Roads
load("processdata/recruits_roads.rda")
str(recruits_roads)
load("output/recruitment_07_12_2020/rec_r_beta4.rda")
summary(rec_r_beta4)

# scale
recruits_roads$beitetrykk9 <- scale(recruits_roads$beitetrykk9)
recruits_roads$helling <- scale(recruits_roads$helling)
recruits_roads$HOH <- scale(recruits_roads$HOH)
recruits_roads$moose_density <- scale(recruits_roads$moose_density)



p_rec_beta1 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("distvei2  [0:500]"))
p_rec_beta1 <- p_rec_beta1 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Distance to road\n") +
  ylab("Recruitment\n")


p_rec_beta2 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("skogkategori"))
p_rec_beta2 <- p_rec_beta2 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 12, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30"),
    axis.text.x = element_text(angle = 30)) +
  xlab("Forest category\n") +
  ylab("Recruitment\n") 


p_rec_beta3 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("treartgruppe9"))
p_rec_beta3 <- p_rec_beta3 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Tree species group\n") +
  ylab("Recruitment\n") 


p_rec_beta4 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("kant"))
p_rec_beta4 <- p_rec_beta4 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 12, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30"),
    axis.text.x = element_text(angle = 30)) +
  xlab("Edge\n") +
  ylab("Recruitment\n")


p_rec_beta5 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("helling [all]"))
p_rec_beta5 <- p_rec_beta5 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Slope\n") +
  ylab("Recruitment\n")


p_rec_beta6 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("HOH [all]"))
p_rec_beta6 <- p_rec_beta6 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Altitude\n") +
  ylab("Recruitment\n")


p_rec_beta7 <- plot_model(rec_r_beta4, type = c("eff"), transform = NULL, terms = c("beitetrykk9 [all]"))
p_rec_beta7 <- p_rec_beta7 + theme_light() +
  theme(plot.title = element_blank(),
    axis.text = element_text(family = "sans", size = 20, color = "grey30"),
        axis.title = element_text(family = "sans", size = 20, color = "grey30")) +
  xlab("Browsing pressure\n") +
  ylab("Recruitment\n")





library(gridExtra)
grid.arrange(p_rec_beta1_house, p_rec_beta1, p_rec_beta2, p_rec_beta3, p_rec_beta7, p_rec_beta4, p_rec_beta5, p_rec_beta6,
          nrow = 4, ncol = 2)
```