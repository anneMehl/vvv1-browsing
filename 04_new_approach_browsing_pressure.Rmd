---
title: "new_approach"
author: "anne"
date: "9 januar 2019"
output: word_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
load("processdata/browse9bro_dist.rda")
browse9bro_dist$beitetrykkr <- as.integer(browse9bro_dist$beitetrykkr)
browse9bro_dist$bt100 <- browse9bro_dist$beitetrykkr/100
```

```{r}
load("processdata/browse_9.rda")
browse_9$beitetrykkr <- as.integer(round(browse_9$beitetrykk))
browse_9$bt100 <- browse_9$beitetrykkr/100
```


```{r}
load("processdata/browse_9_dist.rda")
browse_9_dist$beitetrykkr <- as.integer(round(browse_9_dist$beitetrykk))
browse_9_dist$bt100 <- browse_9_dist$beitetrykkr/100
```

#### Modelling spatial autocorrelation (https://onlinelibrary.wiley.com/doi/full/10.1111/j.2007.0906-7590.05171.x)
Change the projection and make coordinates and a spatial point data frame to make a shapefile

```{r}
unite(browse9bro_dist, UTMmerge, c(UTM_OV_33, UTM_SN_33), remove = FALSE)
duplicated(browse9bro_dist$UTMmerge)
```


```{r}

library(sp)
library(rgdal)

crs <- CRS("+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs")
coords <- cbind(browse9bro_dist$UTM_OV_33, browse9bro_dist$UTM_SN_33)
data_spdf <- SpatialPointsDataFrame(coords, browse9bro_dist, proj4string = crs)
plot(data_spdf)
writeOGR(data_spdf, dsn = "output", layer = "spdf", driver = "ESRI Shapefile")

```


```{r}

library(spdep)
# ?autocov_dist

# prepare neighbour lists for spatial autocorrelation analysis
# nb.list <- dnearneigh(as.matrix(browse9bro_dist[browse9bro_dist$bt100 != 0, c("UTM_OV_33", "UTM_SN_33")]), 0, 5000)
# nb.weights <- nb2listw(nb.list, zero.policy = TRUE)

# Make a matrix of coordinates - use when chunk above was not run
coords <- as.matrix(cbind(browse_9_dist$UTM_OV_33, browse_9_dist$UTM_SN_33))

# compute the autocovariate based on the above distance and weight

ac <- autocov_dist(browse_9_dist$bt100, coords, nbs = 5000, type="inverse", zero.policy = TRUE)
browse_9_dist$ac <- ac

# moran.plot(resid_m1abeta, nb.weights, zero.policy = TRUE, spChk = NULL, labels = TRUE, xlab = NULL, ylab = NULL, quiet = NULL)
# 
# moran.test(resid_m1beta, nb.weights, zero.policy = TRUE, randomisation=TRUE,
#  alternative="greater", rank = FALSE, na.action=na.fail, spChk=NULL,
#  adjust.n=TRUE, drop.EI2=FALSE)
# 
# moran.test(resid_m1abeta, nb.weights, zero.policy = TRUE, randomisation=TRUE,
#  alternative="greater", rank = FALSE, na.action=na.fail, spChk=NULL,
#  adjust.n=TRUE, drop.EI2=FALSE)

save(browse_9_dist, file = "browse_9_dist.rda")


```




#### First part of a hurdle/ zeroinlf model to account for zero inflation
##### glm
```{r}
m1bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + I(HOH^2) + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m2bin <- glm(factor(beitetrykkr > 0) ~ distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m3bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m4bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m5bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m6bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m7bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m8bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m9bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m10bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m11bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m12bin <- glm(factor(beitetrykkr > 0) ~ skogkategori + treartgruppe + ac + region + kant + helling + HOH +  + I(HOH^2) + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m13bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m14bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + treartgruppe + ac + region + kant + helling + HOH + I(HOH^2) + tretetthet,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m15bin <- glm(factor(beitetrykkr > 0) ~ disthus + treartgruppe + ac + region + kant + helling + HOH + I(HOH^2) + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m15abin <- glm(factor(beitetrykkr > 0) ~ disthus + treartgruppe + ac + KOMNR + kant + helling + HOH + I(HOH^2) + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m16bin <- glm(factor(beitetrykkr > 0) ~ disthus + treartgruppe + ac + region + kant + helling + HOH + I(HOH^2) + tretetthet,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m17bin <- glm(factor(beitetrykkr > 0) ~ disthus + distvei1 + treartgruppe + ac + region + kant + helling + HOH + I(HOH^2) + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m18bin <- glm(factor(beitetrykkr > 0) ~ disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + I(HOH^2) + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

```

```{r}
AIC(m1bin, m2bin, m3bin, m4bin, m5bin, m6bin, m7bin, m8bin, m9bin, m10bin, m11bin, m12bin, m13bin, m14bin, m15bin)
# lowest AIC m1bin and 15, 15 is the more parsimonious 
AIC(m15bin, m16bin, m17bin, m18bin) # still 15 then
AIC(m15bin, m15abin)
```


```{r}
summary(m15bin)
summary(m15abin)

plot(allEffects(m15abin))
plot(Effect("region", m1bbin))
plot(Effect("disthus", m1bbin))
plot(Effect("distvei1", m1bbin))
browse_9_dist$KOMNR <- as.factor(browse_9_dist$KOMNR)
plot(Effect("KOMNR", m15abin))

```



#### glmm bin
```{r}
browse_9_dist$HOH_scale = scale(browse_9_dist$HOH)
browse_9_dist$tretetthet_scale = scale(browse_9_dist$tretetthet)
browse_9_dist$helling_scale = scale(browse_9_dist$helling)
browse_9_dist$disthus_cut210_scale = scale(browse_9_dist$disthus_cut210)
browse_9_dist$distvei1_scale = scale(browse_9_dist$distvei1)
browse_9_dist$ac_scale = scale(browse_9_dist$ac)

browse_9_dist$bt_bin <- ifelse(browse_9_dist$beitetrykkr == 0, 0, 1)


m1glmm <- glmer(bt_bin ~ disthus_cut210_scale + treartgruppe + ac + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori*distvei1_scale + (1|region),
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m2glmm <- glmer(bt_bin ~ disthus_cut210_scale + treartgruppe + ac + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori*distvei1_scale + (1|region),
            family = binomial(),
            data = browse_9_dist)

m3glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + treartgruppe + ac + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori*distvei1_scale + (1|region),
            family = binomial(),
            data = browse_9_dist)
# m2 and m3 bring same results in the summary ("different" response)

m4glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + treartgruppe + ac_scale + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori*distvei1_scale + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist,
            control = glmerControl(check.conv.grad = .makeCC("warning", tol = 3e-3, relTol = NULL)))

m5glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + treartgruppe + ac + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori*distvei1_scale + (1|KOMNR),
            family = binomial(link = "cloglog"),
            data = browse_9_dist)

m6glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + distvei1_scale + ac + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m7glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + ac + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m8glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + distvei1_scale + treartgruppe + ac + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m9glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + distvei1_scale + treartgruppe + kant + ac + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m9glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + distvei1_scale + treartgruppe + kant + ac + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m10glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + treartgruppe + ac + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m11glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + distvei1_scale + treartgruppe + ac + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist)

m12glmm <- glmer(factor(beitetrykkr > 0) ~ disthus_cut210_scale + distvei1_scale + treartgruppe + ac_scale + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori + (1|KOMNR),
            family = binomial(),
            data = browse_9_dist,
            control = glmerControl(check.conv.grad = .makeCC("warning", tol = 4e-2, relTol = NULL)))


```

```{r}
AIC(m4glmm, m5glmm) # m4 lower
AIC(m4glmm, m6glmm, m7glmm, m8glmm, m9glmm, m10glmm, m11glmm, m12glmm)
AIC(m4glmm, m12glmm) 
```

```{r}
plot(allEffects(m4glmm))
plot_model(m4glmm, type = "eff")
```

```{r}
# CHeck singularity (in case of model failed to converge)
tt <- getME(m4glmm,"theta")
ll <- getME(m4glmm,"lower")
min(tt[ll==0])

allFit(m4glmm)
```



#### Instead of having the second part of a hurdle or zeroinfl model, use a beta regression, because we have percentage data (use a subset of the dataset with only response values above 0) - need to account for spatial autocorrelation
```{r}

m1beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m1abeta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0) # nbs (in ac) = 5000

m1bbeta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m2beta <- betareg(bt100 ~ distvei1 + ac,
            data = browse_9_dist,
            subset = beitetrykkr > 0) 

m3beta <- betareg(bt100 ~ distvei1 + disthus+ ac,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m3abeta <- betareg(bt100 ~ disthus+ ac,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m4beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + ac,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m5beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m6beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m7beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m8beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m9beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet,
            data = browse_9_dist,
            subset = beitetrykkr > 0)


m10beta <- betareg(bt100 ~ distvei1 + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m11beta <- betareg(bt100 ~ disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m12beta <- betareg(bt100 ~ skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m13beta <- betareg(bt100 ~ distvei1 + disthus + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m14beta <- betareg(bt100 ~ treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m15beta <- betareg(bt100 ~ distvei1 + disthus + treartgruppe + ac + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

m16beta <- betareg(bt100 ~ treartgruppe + ac + KOMNR + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse_9_dist,
            subset = beitetrykkr > 0)

```


```{r}
browse_9_distsub <- browse_9_dist[browse_9_dist$bt100 > 0, ]

m1glmmbeta <- glmmTMB(bt100 ~ treartgruppe + ac_scale + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + skogkategori*distvei1_scale + (1|KOMNR),
                    data = browse_9_distsub,
                    family = beta_family())

m2glmmbeta <- glmmTMB(bt100 ~ disthus_cut210_scale + treartgruppe + ac_scale + kant + helling_scale + HOH_scale + I(HOH_scale^1) + tretetthet_scale + skogkategori*distvei1_scale + (1|KOMNR),
                      data = browse_9_distsub,
                      family = beta_family())

m3glmmbeta <- glmmTMB(bt100 ~ treartgruppe + ac_scale + kant + helling_scale + HOH_scale + I(HOH_scale^2) + tretetthet_scale + (1|KOMNR),
                    data = browse_9_distsub,
                    family = beta_family())
# Do full model selection...

```



```{r}

AIC(m1beta, m1abeta, m1bbeta, m2beta, m3beta, m4beta, m5beta, m6beta, m7beta, m8beta, m9beta)
# m1bbeta and m13beta lowest AIC, but also m14 is really the same...
AIC(m1bbeta, m13beta, m14beta, m15beta)

AIC(m1glmmbeta, m2glmmbeta, m3glmmbeta)

```


```{r}
summary(m1beta)
summary(m1bbeta)
vcov(m1abeta)

lrtest(m1beta, m1abeta)

plot(m1beta)
plot(m1abeta)

visreg(m1abeta, type = "conditional", scale = "response")
visreg(m1abeta, type = "contrast", scale = "response")

resid_m1beta <- resid(m1beta, type = "pearson")
resid_m1abeta <- resid(m1abeta, type = "pearson")

predbetareg <- cbind(
predict(m1abeta, type = "response"), # fitted means of response
predict(m1abeta, type = "link"), # corresponding linear predictor
predict(m1abeta, type = "variance"), # fitted variances of response
predict(m1abeta, type = "quantile", at = c(0.25, 0.5, 0.75)) # r fitted quantile(s) of the response distribution
)
colnames(predbetareg) <- c("response", "link", "variance", "qu0.25", "qu0.5", "qu0.75")

head(predbetareg)

broom::tidy(m1bbeta)
broom::augment(m1bbeta)

browse9bro_dist_sub <- browse9bro_dist[browse9bro_dist$bt100 != 0, ]

browse9bro_dist_sub$model <- predict(m1bbeta)
ggplot(data = browse9bro_dist_sub, aes(x = model, y = bt100)) + 
   geom_point() + geom_abline(slope = 1)

plot_model(model = m1bbeta, type = "eff", terms = c("distvei1", "disthus"))
get_model_data(m1bbeta)
ggpredict(m1bbeta, terms = "distvei1")

```


## New package glmmTMB, for glmm and extentions (zero-inlfated with random effects, hurdle...)
- hurdle model does not work with beta family... But he says in his FAQ doc: "If you think that zero values are generated by a separate process, the simplest solution is to fit a Bernoulli model to the zero/non-zero data, then a conditional continuous model for the non-zero values; this is effectively a hurdle model."
```{r}
m1ziglmm <- glmmTMB(bt100 ~ disthus + (1|KOMNR),
                    data = browse_9_dist,
                    subset(), # make a datasubset...
                    ziformula = ~ 0,
                    family = beta_family())



# Hurdle Poisson model
glmmTMBhurdle1 <- glmmTMB(beitetrykkr ~ treartgruppe + ac + kant + helling + HOH + tretetthet + skogkategori*distvei1 + (1|KOMNR),
                          zi = ~ disthus + treartgruppe + ac + kant + helling + HOH + I(HOH^2) + tretetthet + skogkategori*distvei1,
                          family = truncated_poisson, 
                          data = browse_9_dist)
# NA/NaN function evaluationModel convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')Model convergence problem; function evaluation limit reached without convergence (9). See vignette('troubleshooting')

glmmTMBhurdle2 <- glmmTMB(beitetrykkr ~ distvei1 + disthus_cut210 + (1|KOMNR),
                          zi = ~ distvei1 + disthus_cut210,
                          family = truncated_poisson, 
                          data = browse_9_dist) # works


glmmTMBhurdle2a <- glmmTMB(beitetrykkr ~ distvei1 + disthus_cut210 + (1|KOMNR),
                          zi = ~ distvei1 + disthus_cut210,
                          family = beta_family(), 
                          data = browse_9_dist) # doesn't work: Error in eval(family$initialize) : y values must be 0 < y < 1

```



























