---
title: "new_approach"
author: "anne"
date: "9 januar 2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
load("processdata/browse9bro_dist.rda")
browse9bro_dist$beitetrykkr <- as.integer(browse9bro_dist$beitetrykkr)
browse9bro_dist$bt100 <- browse9bro_dist$beitetrykkr/100
```


#### Modelling spatial autocorrelation (https://onlinelibrary.wiley.com/doi/full/10.1111/j.2007.0906-7590.05171.x)
Change the projection and make coordinates and a spatial point data frame to make a shapefile

```{r}
unite(browse9bro_dist, UTMmerge, c(UTM_OV_33, UTM_SN_33), remove = FALSE)
duplicated(browse9bro_dist$UTMmerge)
```


```{r}

library(sp)
library(rgdal)

crs <- CRS("+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs")
coords <- cbind(browse9bro_dist$UTM_OV_33, browse9bro_dist$UTM_SN_33)
data_spdf <- SpatialPointsDataFrame(coords, browse9bro_dist, proj4string = crs)
plot(data_spdf)
writeOGR(data_spdf, dsn = "output", layer = "spdf", driver = "ESRI Shapefile")

```


```{r}

library(spdep)
# ?autocov_dist

# prepare neighbour lists for spatial autocorrelation analysis
nb.list <- dnearneigh(as.matrix(browse9bro_dist[browse9bro_dist$bt100 != 0, c("UTM_OV_33", "UTM_SN_33")]), 0, 5000)
nb.weights <- nb2listw(nb.list, zero.policy = TRUE)

# Make a matrix of coordinates - use when chunk above was not run
coords <- as.matrix(cbind(browse9bro_dist$UTM_OV_33, browse9bro_dist$UTM_SN_33))

# compute the autocovariate based on the above distance and weight

ac <- autocov_dist(browse9bro_dist$bt100, coords, nbs = 5000, type="inverse", zero.policy = TRUE)
browse9bro_dist$ac <- ac

# moran.plot(resid_m1abeta, nb.weights, zero.policy = TRUE, spChk = NULL, labels = TRUE, xlab = NULL, ylab = NULL, quiet = NULL)

moran.test(resid_m1beta, nb.weights, zero.policy = TRUE, randomisation=TRUE, 
 alternative="greater", rank = FALSE, na.action=na.fail, spChk=NULL,
 adjust.n=TRUE, drop.EI2=FALSE)

moran.test(resid_m1abeta, nb.weights, zero.policy = TRUE, randomisation=TRUE, 
 alternative="greater", rank = FALSE, na.action=na.fail, spChk=NULL,
 adjust.n=TRUE, drop.EI2=FALSE)



```




#### First part of a hurdle/ zeroinlf model to account for zero inflation
```{r}
m1bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m1abin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m2bin <- glm(factor(beitetrykkr > 0) ~ distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m3bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m4bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m5bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m6bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m7bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m8bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m9bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m10bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m11bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m12bin <- glm(factor(beitetrykkr > 0) ~ skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m13bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m14bin <- glm(factor(beitetrykkr > 0) ~ distvei1 + treartgruppe + ac + region + kant + helling + HOH + tretetthet,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

m15bin <- glm(factor(beitetrykkr > 0) ~ disthus + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            family = binomial(link = "cloglog"),
            data = browse9bro_dist)

```


```{r}
AIC(m1bin, m1abin, m2bin, m3bin, m4bin, m5bin, m6bin, m7bin, m8bin, m9bin, m10bin)
# lowest AIC m11bin, m12bin, m13bin (m1abin has one point difference)
AIC(m1abin, m11bin, m12bin, m13bin, m14bin, m15bin)
```
```{r}
summary(m13bin)

plot(allEffects(m11bin))
plot_model(m11bin)

```




#### Instead of having the second part of a hurdle or zeroinfl model, use a beta regression, because we have percentage data (use a subset of the dataset with only response values above 0) - need to account for spatial autocorrelation
```{r}

m1beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m1abeta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0) # nbs (in ac) = 5000

m1bbeta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m2beta <- betareg(bt100 ~ distvei1 + ac,
            data = browse9bro_dist,
            subset = beitetrykkr > 0) 

m3beta <- betareg(bt100 ~ distvei1 + disthus+ ac,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m3abeta <- betareg(bt100 ~ disthus+ ac,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m4beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + ac,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m5beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m6beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m7beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m8beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m9beta <- betareg(bt100 ~ distvei1 + disthus + skogkategori + treartgruppe + ac + kant + helling + HOH + tretetthet,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)


m10beta <- betareg(bt100 ~ distvei1 + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m11beta <- betareg(bt100 ~ disthus + skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m12beta <- betareg(bt100 ~ skogkategori + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m13beta <- betareg(bt100 ~ distvei1 + disthus + treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m14beta <- betareg(bt100 ~ treartgruppe + ac + region + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)

m15beta <- betareg(bt100 ~ distvei1 + disthus + treartgruppe + ac + kant + helling + HOH + tretetthet + skogkategori*distvei1,
            data = browse9bro_dist,
            subset = beitetrykkr > 0)



```



```{r}

AIC(m1beta, m1abeta, m1bbeta, m2beta, m3beta, m4beta, m5beta, m6beta, m7beta, m8beta, m9beta)
# m1bbeta and m13beta lowest AIC, but also m14 is really the same...
AIC(m1bbeta, m13beta, m14beta, m15beta)

```


```{r}
summary(m1beta)
summary(m1bbeta)
vcov(m1abeta)

lrtest(m1beta, m1abeta)

plot(m1beta)
plot(m1abeta)

visreg(m1abeta, type = "conditional", scale = "response")
visreg(m1abeta, type = "contrast", scale = "response")

resid_m1beta <- resid(m1beta, type = "pearson")
resid_m1abeta <- resid(m1abeta, type = "pearson")

predbetareg <- cbind(
predict(m1abeta, type = "response"), # fitted means of response
predict(m1abeta, type = "link"), # corresponding linear predictor
predict(m1abeta, type = "variance"), # fitted variances of response
predict(m1abeta, type = "quantile", at = c(0.25, 0.5, 0.75)) # r fitted quantile(s) of the response distribution
)
colnames(predbetareg) <- c("response", "link", "variance", "qu0.25", "qu0.5", "qu0.75")

head(predbetareg)

# variocloud <- variogram(resid_m1beta ~ 1, data = browse9bro_dist, cloud = TRUE)
# plot(variocloud)

```




























